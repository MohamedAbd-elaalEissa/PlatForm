import{a as g}from"./chunk-LCP6WAMI.js";import{e as m,p as k}from"./chunk-EIK6HXDD.js";import{G as u,W as d,Z as l,aa as f,ca as s,l as h,q as a}from"./chunk-OT2PUON7.js";var j=new f("JWT_OPTIONS"),w=(()=>{class n{constructor(e=null){this.tokenGetter=e&&e.tokenGetter||function(){}}urlBase64Decode(e){let r=e.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:{r+="==";break}case 3:{r+="=";break}default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(r)}b64decode(e){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o="";if(e=String(e).replace(/=+$/,""),e.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let c=0,p,i,b=0;i=e.charAt(b++);~i&&(p=c%4?p*64+i:i,c++%4)?o+=String.fromCharCode(255&p>>(-2*c&6)):0)i=r.indexOf(i);return o}b64DecodeUnicode(e){return decodeURIComponent(Array.prototype.map.call(this.b64decode(e),r=>"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)).join(""))}decodeToken(e=this.tokenGetter()){return e instanceof Promise?e.then(r=>this._decodeToken(r)):this._decodeToken(e)}_decodeToken(e){if(!e||e==="")return null;let r=e.split(".");if(r.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let o=this.urlBase64Decode(r[1]);if(!o)throw new Error("Cannot decode the token.");return JSON.parse(o)}getTokenExpirationDate(e=this.tokenGetter()){return e instanceof Promise?e.then(r=>this._getTokenExpirationDate(r)):this._getTokenExpirationDate(e)}_getTokenExpirationDate(e){let r;if(r=this.decodeToken(e),!r||!r.hasOwnProperty("exp"))return null;let o=new Date(0);return o.setUTCSeconds(r.exp),o}isTokenExpired(e=this.tokenGetter(),r){return e instanceof Promise?e.then(o=>this._isTokenExpired(o,r)):this._isTokenExpired(e,r)}_isTokenExpired(e,r){if(!e||e==="")return!0;let o=this.getTokenExpirationDate(e);return r=r||0,o===null?!1:!(o.valueOf()>new Date().valueOf()+r*1e3)}getAuthScheme(e,r){return typeof e=="function"?e(r):e}}return n.\u0275fac=function(e){return new(e||n)(s(j))},n.\u0275prov=l({token:n,factory:n.\u0275fac}),n})();var T=class n{constructor(t,e,r){this.http=t;this.router=e;this.jwtHelper=r}apiUrl=`${g.apiUrl}Identity`;accessTokenSubject=new h(null);isRefreshing=!1;Register(t){return this.http.post(`${this.apiUrl}/register`,t,{responseType:"text"})}signIn(t){return this.http.post(`${this.apiUrl}/Login`,t).pipe(d(e=>{this.setTokens(e),this.accessTokenSubject.next(e),this.getAccessToken()}),u(this.handleError))}refreshToken(){let t=this.getRefreshToken();return t?this.http.post(`${this.apiUrl}/refresh`,{refreshToken:t}).pipe(d(e=>{this.setTokens(e),this.accessTokenSubject.next(e)}),u(e=>(console.error("Refresh token API error:",e),this.logout(),this.router.navigate(["/auth/login"]),a(()=>e)))):(this.logout(),a(()=>new Error("No refresh token available")))}setTokens(t){localStorage.setItem("token",JSON.stringify(t))}logout(){localStorage.removeItem("token"),this.accessTokenSubject.next(null)}getAccessToken(){try{let t=localStorage.getItem("token");return t?JSON.parse(t)?.token??null:null}catch(t){return console.error("Invalid token in localStorage:",t),null}}getRefreshToken(){let t=localStorage.getItem("token");if(!t)return null;try{return JSON.parse(t)?.refreshToken||null}catch(e){return console.error("Invalid token format",e),null}}getAccessTokenSubject(){return this.accessTokenSubject}GetUserRoles(t){return this.http.get(`${this.apiUrl}/GetUserRoles?email=`+t)}getUserEmail(){let t=localStorage.getItem("token");if(t){let e=JSON.parse(t);return this.jwtHelper.decodeToken(e.token)?.email}return""}handleError(t){let e={type:"UnknownError",message:"An unexpected error occurred",status:t.status||500,errors:null,timestamp:new Date().toISOString()};return t.error&&typeof t.error=="object"&&(e={type:t.error.type||"UnknownError",message:t.error.message||"An error occurred",status:t.error.statusCode||t.status,errors:t.error.errors||null,stackTrace:t.error.stackTrace||null,timestamp:t.error.timestamp||new Date().toISOString()}),a(()=>e)}static \u0275fac=function(e){return new(e||n)(s(m),s(k),s(w))};static \u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})};export{j as a,w as b,T as c};
