import{a as k}from"./chunk-LCP6WAMI.js";import{c as m,n as g}from"./chunk-VOCEMQJD.js";import{$ as f,F as u,V as h,Y as l,ba as s,l as p,q as a}from"./chunk-QU4N54WN.js";var j=new f("JWT_OPTIONS"),w=(()=>{class n{constructor(e=null){this.tokenGetter=e&&e.tokenGetter||function(){}}urlBase64Decode(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:{t+="==";break}case 3:{t+="=";break}default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(t)}b64decode(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o="";if(e=String(e).replace(/=+$/,""),e.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let c=0,d,i,T=0;i=e.charAt(T++);~i&&(d=c%4?d*64+i:i,c++%4)?o+=String.fromCharCode(255&d>>(-2*c&6)):0)i=t.indexOf(i);return o}b64DecodeUnicode(e){return decodeURIComponent(Array.prototype.map.call(this.b64decode(e),t=>"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)).join(""))}decodeToken(e=this.tokenGetter()){return e instanceof Promise?e.then(t=>this._decodeToken(t)):this._decodeToken(e)}_decodeToken(e){if(!e||e==="")return null;let t=e.split(".");if(t.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let o=this.urlBase64Decode(t[1]);if(!o)throw new Error("Cannot decode the token.");return JSON.parse(o)}getTokenExpirationDate(e=this.tokenGetter()){return e instanceof Promise?e.then(t=>this._getTokenExpirationDate(t)):this._getTokenExpirationDate(e)}_getTokenExpirationDate(e){let t;if(t=this.decodeToken(e),!t||!t.hasOwnProperty("exp"))return null;let o=new Date(0);return o.setUTCSeconds(t.exp),o}isTokenExpired(e=this.tokenGetter(),t){return e instanceof Promise?e.then(o=>this._isTokenExpired(o,t)):this._isTokenExpired(e,t)}_isTokenExpired(e,t){if(!e||e==="")return!0;let o=this.getTokenExpirationDate(e);return t=t||0,o===null?!1:!(o.valueOf()>new Date().valueOf()+t*1e3)}getAuthScheme(e,t){return typeof e=="function"?e(t):e}}return n.\u0275fac=function(e){return new(e||n)(s(j))},n.\u0275prov=l({token:n,factory:n.\u0275fac}),n})();var b=class n{constructor(r,e,t){this.http=r;this.router=e;this.jwtHelper=t}apiUrl=`${k.apiUrl}Identity`;accessTokenSubject=new p(null);isRefreshing=!1;Register(r){return this.http.post(`${this.apiUrl}/register`,r,{responseType:"text"})}signIn(r){return this.http.post(`${this.apiUrl}/Login`,r).pipe(h(e=>{debugger;this.setTokens(e),this.accessTokenSubject.next(e),this.getAccessToken()}),u(e=>a(()=>e)))}refreshToken(){debugger;let r=this.getRefreshToken();return r?this.http.post(`${this.apiUrl}/refresh`,{refreshToken:r}).pipe(h(e=>{debugger;this.setTokens(e),this.accessTokenSubject.next(e)}),u(e=>{debugger;return console.error("Refresh token API error:",e),this.logout(),this.router.navigate(["/auth/login"]),a(()=>e)})):(this.logout(),a(()=>new Error("No refresh token available")))}setTokens(r){localStorage.setItem("token",JSON.stringify(r))}logout(){localStorage.removeItem("token"),this.accessTokenSubject.next(null)}getAccessToken(){debugger;try{let r=localStorage.getItem("token");return r?JSON.parse(r)?.token??null:null}catch(r){return console.error("Invalid token in localStorage:",r),null}}getRefreshToken(){debugger;return JSON.parse(localStorage.getItem("token")||"null").refreshToken}getAccessTokenSubject(){return this.accessTokenSubject}GetUserRoles(r){return this.http.get(`${this.apiUrl}/GetUserRoles?email=`+r)}getUserEmail(){debugger;let r=localStorage.getItem("token");if(r){let e=JSON.parse(r);return this.jwtHelper.decodeToken(e.token)?.email}return""}static \u0275fac=function(e){return new(e||n)(s(m),s(g),s(w))};static \u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})};export{j as a,w as b,b as c};
